<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pathumi Garment Salary Calculator</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4facfe;
            --secondary-color: #00f2fe;
            --accent-color: #ffffff;
            --text-color: #333;
            --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --input-border: #e0e0e0;
            --danger-color: #ff6b6b;
            --success-color: #2ecc71;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--bg-gradient);
            margin: 0;
            padding: 40px 20px;
            color: var(--text-color);
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 2.5em;
            margin: 0;
            color: #2c3e50;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        header .subtitle {
            font-size: 1.1em;
            color: #7f8c8d;
            margin-top: 10px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .employee-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .employee-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            position: relative;
            transition: transform 0.2s;
            border-top: 5px solid var(--primary-color);
        }

        .employee-card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .card-header h3 {
            margin: 0;
            font-size: 1.25em;
            color: #34495e;
        }

        .remove-btn {
            background: transparent;
            border: none;
            color: #95a5a6;
            cursor: pointer;
            font-size: 24px;
            padding: 0;
            line-height: 1;
            transition: color 0.2s;
        }

        .remove-btn:hover {
            color: var(--danger-color);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9em;
            color: #555;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            /* Fix width issues */
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .row {
            display: flex;
            gap: 15px;
        }

        .col {
            flex: 1;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .checkbox-wrapper input {
            width: auto;
        }

        .result-section {
            margin-top: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 1px dashed #ced4da;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-total {
            margin-top: 10px;
            font-size: 1.2em;
            font-weight: 700;
            color: var(--success-color);
            text-align: right;
        }

        /* PDF Generation overlay */
        #pdf-container {
            position: fixed;
            left: -9999px;
            top: 0;
            width: 210mm;
            /* A4 width */
        }

        @media (max-width: 600px) {
            .employee-list {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                justify-content: center;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>Pathumi Garment</h1>
            <div class="subtitle">Advanced Salary Calculator</div>
        </header>

        <div class="controls">
            <button class="btn btn-primary" onclick="addEmployee()">
                <span class="material-icons">add</span> Add Employee
            </button>
            <div>
                <button class="btn btn-success" onclick="calculateAll()">
                    <span class="material-icons">calculate</span> Calculate All
                </button>
                <button class="btn btn-danger" onclick="downloadAllPDF()">
                    <span class="material-icons">picture_as_pdf</span> Download All Slips
                </button>
                <button class="btn btn-primary" style="background: #6c757d;" onclick="clearAllData()">
                    <span class="material-icons">delete_sweep</span> Reset
                </button>
            </div>
        </div>

        <div id="employeeList" class="employee-list">
            <!-- Employee Cards will be injected here -->
        </div>
    </div>

    <!-- Hidden container for PDF generation -->
    <div id="pdf-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // --- State Management ---
        let employees = [];

        // Load data from LocalStorage on startup
        window.onload = function () {
            const storedData = localStorage.getItem('pg_salary_employees');
            if (storedData) {
                employees = JSON.parse(storedData);
            } else {
                // Default initial state with one empty employee
                addEmployee(false);
            }
            renderEmployees();
        };

        function saveData() {
            localStorage.setItem('pg_salary_employees', JSON.stringify(employees));
        }

        function addEmployee(save = true) {
            const id = Date.now().toString(); // Simple unique ID
            employees.push({
                id: id,
                name: '',
                days: 0,
                attStatus: '15000',
                rate: '',
                otHours: 0,
                otRate: 0,
                advance: 0,
                epfApplicable: true,
                epfPercent: 8,
                result: null // Store calculation result
            });
            if (save) saveData();
            renderEmployees();
        }

        function removeEmployee(id) {
            if (confirm("Are you sure you want to remove this employee?")) {
                employees = employees.filter(emp => emp.id !== id);
                saveData();
                renderEmployees();
            }
        }

        function clearAllData() {
            if (confirm("This will delete ALL employee data. Are you sure?")) {
                employees = [];
                addEmployee(); // Add one fresh
            }
        }

        function updateEmployee(id, field, value) {
            const emp = employees.find(e => e.id === id);
            if (emp) {
                emp[field] = value;
                // Clear previous result on edit to indicate need for recalculation
                // emp.result = null; 
                saveData();
                // We don't re-render entire list on every keystroke to maintain focus
                // But we do need to update the specific calculation if it exists
                if (field === 'epfApplicable') {
                    // Force re-render for checkbox logic usually
                    renderEmployees();
                }
            }
        }

        // --- Rendering ---
        function renderEmployees() {
            const container = document.getElementById('employeeList');
            container.innerHTML = '';

            employees.forEach((emp, index) => {
                const card = document.createElement('div');
                card.className = 'employee-card';

                // Should EPF input be disabled?
                const epfDisabled = !emp.epfApplicable;

                card.innerHTML = `
                <div class="card-header">
                    <h3>Employee ${index + 1}</h3>
                    <button class="remove-btn" onclick="removeEmployee('${emp.id}')">&times;</button>
                </div>

                <div class="form-group">
                    <label>Name</label>
                    <input type="text" value="${emp.name}" oninput="updateEmployee('${emp.id}', 'name', this.value)" placeholder="Enter Name">
                </div>

                <div class="row">
                    <div class="col">
                        <label>Days</label>
                        <input type="number" value="${emp.days}" oninput="updateEmployee('${emp.id}', 'days', +this.value)">
                    </div>
                    <div class="col">
                        <label>Rate</label>
                        <select onchange="updateEmployee('${emp.id}', 'rate', +this.value)">
                            <option value="" ${emp.rate === '' ? 'selected' : ''}>Select</option>
                            <option value="1100" ${emp.rate === 1100 ? 'selected' : ''}>1100</option>
                            <option value="1200" ${emp.rate === 1200 ? 'selected' : ''}>1200</option>
                            <option value="1300" ${emp.rate === 1300 ? 'selected' : ''}>1300</option>
                            <option value="1400" ${emp.rate === 1400 ? 'selected' : ''}>1400</option>
                            <option value="1500" ${emp.rate === 1500 ? 'selected' : ''}>1500</option>
                            <option value="1600" ${emp.rate === 1600 ? 'selected' : ''}>1600</option>
                            <option value="1800" ${emp.rate === 1800 ? 'selected' : ''}>1800</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Attendance Status</label>
                    <select onchange="updateEmployee('${emp.id}', 'attStatus', this.value)">
                        <option value="15000" ${emp.attStatus === '15000' ? 'selected' : ''}>Super Full Print (15000)</option>
                        <option value="5000" ${emp.attStatus === '5000' ? 'selected' : ''}>Half Print (5000)</option>
                        <option value="4000" ${emp.attStatus === '4000' ? 'selected' : ''}>Full Down (4000)</option>
                        <option value="2000" ${emp.attStatus === '2000' ? 'selected' : ''}>Half Down (2000)</option>
                        <option value="0" ${emp.attStatus === '0' ? 'selected' : ''}>Full Absent (0)</option>
                    </select>
                </div>

                <div class="row">
                    <div class="col">
                        <label>OT Hours</label>
                        <input type="number" value="${emp.otHours}" oninput="updateEmployee('${emp.id}', 'otHours', +this.value)">
                    </div>
                    <div class="col">
                        <label>OT Rate</label>
                        <input type="number" value="${emp.otRate}" oninput="updateEmployee('${emp.id}', 'otRate', +this.value)">
                    </div>
                </div>

                <div class="form-group">
                     <label>Advance</label>
                     <input type="number" value="${emp.advance}" oninput="updateEmployee('${emp.id}', 'advance', +this.value)">
                </div>

                <div class="row" style="align-items: center;">
                    <div class="col">
                         <div class="checkbox-wrapper">
                            <input type="checkbox" ${emp.epfApplicable ? 'checked' : ''} onchange="updateEmployee('${emp.id}', 'epfApplicable', this.checked)">
                            <label style="margin:0">EPF</label>
                        </div>
                    </div>
                    <div class="col">
                        <input type="number" value="${emp.epfPercent}" ${epfDisabled ? 'disabled' : ''} oninput="updateEmployee('${emp.id}', 'epfPercent', +this.value)" placeholder="%">
                    </div>
                </div>

                <div id="result-${emp.id}" class="result-section" style="display: none;">
                    <!-- Result injected here -->
                </div>
            `;
                container.appendChild(card);

                // If there's a stored result, show it
                if (emp.result) {
                    showResult(emp.id, emp.result);
                }
            });
        }

        // --- Calculations ---
        function calculateAll() {
            let allValid = true;
            employees.forEach(emp => {
                if (!emp.rate) allValid = false; // Basic validation

                const basic = emp.days * (Number(emp.rate) || 0);
                const otPay = emp.otHours * emp.otRate;
                const bonus = Number(emp.attStatus);
                const epfAmt = emp.epfApplicable ? basic * (emp.epfPercent / 100) : 0;
                const net = basic + otPay + bonus - epfAmt - emp.advance;

                const resultObj = {
                    basic, otPay, bonus, epfAmt, net
                };

                emp.result = resultObj;
                showResult(emp.id, resultObj);
            });

            saveData(); // Save results too

            if (!allValid) {
                alert("Some employees are missing Daily Rates. Calculation performed with defaults.");
            }
        }

        function showResult(id, res) {
            const resDiv = document.getElementById(`result-${id}`);
            if (!resDiv) return;

            resDiv.style.display = 'block';
            resDiv.innerHTML = `
            <div class="result-row"><span>Basic</span><span>${res.basic.toFixed(2)}</span></div>
            <div class="result-row"><span>OT</span><span>${res.otPay.toFixed(2)}</span></div>
            <div class="result-row"><span>Bonus</span><span>${res.bonus.toFixed(2)}</span></div>
            <div class="result-row"><span>EPF (-)</span><span>${res.epfAmt.toFixed(2)}</span></div>
            <div class="result-row"><span>Advance (-)</span><span>${employees.find(e => e.id === id).advance.toFixed(2)}</span></div>
            <div class="result-total">Net: Rs. ${res.net.toFixed(2)}</div>
        `;
        }

        // --- PDF Generation ---
        async function downloadAllPDF() {
            // Ensure calculations are up to date
            calculateAll();

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF("p", "mm", "a4");

            // Date Logic
            const today = new Date();
            const issuedMonthStr = today.toLocaleString('default', { month: 'long', year: 'numeric' });

            const prevMonthDate = new Date();
            prevMonthDate.setMonth(today.getMonth() - 1);
            const salaryMonthStr = prevMonthDate.toLocaleString('default', { month: 'long', year: 'numeric' });

            // Helper to generate HTML for a single slip
            const createSlipHTML = (emp, res) => {
                return `
            <div style="font-family: 'Roboto', sans-serif; padding: 20px; background: #fff; border: 1px solid #000; width: 600px; margin-bottom: 20px;">
                <div style="text-align: center; font-weight: bold; font-size: 18px; margin-bottom: 10px;">Pathumi Garment Salary Slip</div>
                 <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 10px;">
                    <div><strong>Salary For:</strong> ${salaryMonthStr}</div>
                    <div><strong>Issued:</strong> ${issuedMonthStr}</div>
                 </div>
                <hr style="border-top: 1px solid #ccc;">
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <tr><td style="padding: 5px 0;"><strong>Name:</strong></td><td style="text-align: right;"><strong>${emp.name || "Unknown"}</strong></td></tr>
                    <tr><td style="padding: 5px 0;">Basic (${emp.days} days @ ${emp.rate})</td><td style="text-align: right;">${res.basic.toFixed(2)}</td></tr>
                    <tr><td style="padding: 5px 0;">OT (${emp.otHours} hrs @ ${emp.otRate})</td><td style="text-align: right;">${res.otPay.toFixed(2)}</td></tr>
                    <tr><td style="padding: 5px 0;">Bonus</td><td style="text-align: right;">${res.bonus.toFixed(2)}</td></tr>
                    <tr><td style="padding: 5px 0;">EPF Deduction</td><td style="text-align: right;">-${res.epfAmt.toFixed(2)}</td></tr>
                    <tr><td style="padding: 5px 0;">Advance</td><td style="text-align: right;">-${emp.advance.toFixed(2)}</td></tr>
                </table>
                <hr style="border-top: 1px solid #ccc; margin: 10px 0;">
                <div style="text-align: right; font-size: 16px; font-weight: bold; color: #000;">Net Salary: Rs. ${res.net.toFixed(2)}</div>
            </div>
            `;
            };

            const pdfContainer = document.getElementById('pdf-container');
            pdfContainer.innerHTML = '';

            // Prepare all slips in the hidden container
            employees.forEach(emp => {
                if (emp.result) {
                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = createSlipHTML(emp, emp.result);
                    pdfContainer.appendChild(wrapper);
                }
            });

            // Wait for DOM
            await new Promise(r => setTimeout(r, 100));

            const slips = pdfContainer.children;
            let yOffset = 10;
            const pageHeight = 297; // A4 mm
            const slipHeightMM = 100; // Approx height of one slip in mm

            for (let i = 0; i < slips.length; i++) {
                // 2 slips per page basically
                if (yOffset + slipHeightMM > pageHeight) {
                    pdf.addPage();
                    yOffset = 10;
                }

                const canvas = await html2canvas(slips[i], { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                // Scale width to fit A4 margins
                const pdfWidth = 190; // 10mm margins
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

                pdf.addImage(imgData, 'PNG', 10, yOffset, pdfWidth, pdfHeight);

                yOffset += pdfHeight + 10; // spacing
            }

            // Cleanup
            pdfContainer.innerHTML = '';

            pdf.save(`Pathumi_Garment_Returns_${issuedMonthStr}.pdf`);
        }
    </script>

</body>

</html>